# 01.Android系统的框架
#### 目录介绍
- 01.Android组件设计
  - 1.1 AMS核心设计思想
  - 1.2 Binder设计思想
  - 1.3 组件通信设计
  - 1.4 组件通信Intent
  - 1.5 内存回收进程设计




## 01.Android组件设计

组件化设计实现：程序由组件组成；组件与进程剥离；组件皆程序入口

程序由组件组成：Activity：前台交互；Service：后台计算；Broadcast Receiver：广播通信；Content Provider：数据封装

组件与进程剥离：组件关闭时，进程可以继续存在，提高重新启动时的速度；进程关闭时，组件可以继续存在，保护被杀进程里面的组件。

将组件与进程进行剥离，使得进程对组件透明，听起来很好，但是如何解决以下四个问题？

- 谁来负责组件的启动和关闭？
- 谁来维护组件的状态？
- 谁来管理组件运行时所需要的进程？
- 组件之间如何进行通信？

### 1.1 AMS核心设计思想

Android AMS（Activity Manager Service）是Android操作系统中的一个核心组件，负责管理应用程序的生命周期、任务栈、进程和应用间的交互等。

AMS的设计思想主要包括以下几个方面：

1. 统一管理应用生命周期：AMS负责跟踪和管理应用程序的生命周期，包括应用的启动、暂停、停止和销毁等。
2. 任务栈管理：AMS通过任务栈的概念来管理应用程序的活动。每个应用程序都有一个与之关联的任务栈，用于存储应用的活动。AMS可以根据用户的操作，如启动新的应用、返回到上一个应用等，对任务栈进行调度和管理，确保应用的切换和切换顺序的正确性。
3. 进程管理：AMS负责管理应用程序的进程。它根据应用的需求和系统资源的情况，决定何时创建、启动、停止或销毁应用的进程。AMS通过进程间通信（IPC）机制，使应用程序能够在不同的进程中进行交互和通信。
4. 应用间交互：AMS提供了一种机制，使应用程序能够在不同的应用之间进行交互。例如，通过隐式意图（Intent）机制，应用可以请求系统启动其他应用的活动，实现应用间的数据共享和功能调用。
5. 安全性和权限管理：AMS负责应用程序的权限管理和安全性。它确保应用程序只能访问其被授权的资源和功能，并对应用程序的行为进行监控和控制，以保护用户的隐私和系统的安全。

进程管理

- 在适当的时候主动回收空进程和后台进程，以及通知进程自己进行内存回收
- 组件的UID和Process Name唯一决定了其所要运行在的进程。
- 每次组件onStop时，都会将自己的状态传递给AMS维护。

AMS在以下四种情况下会调用trimApplications来主动回收进程：

- A.activityStopped，停止Activity
- B.setProcessLimit，设置进程数量限制
- C.unregisterReceiver，注销Broadcast Receiver
- D.finishReceiver，结束Broadcast Receiver

WMS也会主动回收进程：WindowManagerService在处理窗口的过程中发生Out Of Memroy时，会调用reclaimSomeSurfaceMemoryLocked来回收某些Surface占用的内存，reclaimSomeSurfaceMemoryLocked的逻辑如下所示：

- 1).首先检查有没有泄漏的Surface，即那些Session已经不存在但是还没有销毁的Surface，以及那些宿主Activity已经不可见但是还没有销毁的Surface。如果存在的话，就将它们销毁即可，不用KillPids。
- 2).如果不存在没有泄漏的Surface，那么那些存在Surface的进程都有可能被杀掉，这是通过KillPids来实现的。

### 1.2 Binder设计思想

为组件间通信提供支持：进程间；进程内

高效的IPC机制

1. 进程间的组件通信时，通信数据只需一次拷贝
2. 进程内的组件通信时，跳过IPC进行直接的通信

传统的IPC，通信数据需要执行两次，一次是从源进程的用户空间拷贝到内核空间，二次是从内核空间拷贝到目标进程的用户空间

### 1.3 组件通信设计

组件之间的通信是通过Intent、Broadcast、回调和共享数据等方式实现的。以下是Android中常见的组件通信设计：

1. Intent（意图）：Intent是用于在组件之间传递消息和执行操作的对象。通过在Intent中设置数据和标识符，可以实现不同组件之间的通信和交互。
2. Broadcast（广播）：Broadcast是一种系统级别的消息机制，用于在应用程序内部或与其他应用程序之间进行通信。
3. 回调（Callback）：回调是一种通过接口或抽象类定义的方法，用于在组件之间进行回调通知。
4. 共享数据（Shared Data）：组件之间可以通过共享数据来进行通信。Android提供了ContentProvider机制，允许应用程序共享和访问数据。
5. 组件间直接引用：在某些情况下，组件之间可以直接引用彼此，以实现更紧密的通信。这种方式适用于组件之间需要频繁交互和共享状态的场景。

### 1.4 组件通信Intent

为何要设计Intent？Intent提供了一种统一的机制，使得Android应用程序中的各个组件可以相互协作，共享功能和数据。如果你是谷歌开发者，你会如何设计它？

### 1.5 内存回收进程设计

内存紧张时回收进程，由于组件与进程是剥离的，因此进程回收不会影响组件的生命周期。如果你是谷歌Android架构师，你该如何设计？需要考虑哪些？

1. 低内存级别需要定义：定义了不同的内存级别，如低内存、中等内存和临界内存等级别。方便触发系统按级别回收进程！
2. 进程优先级的设计：多个应用在后台，Android系统为每个进程分配了不同的优先级，如前台进程、可见进程、服务进程和缓存进程等。当内存紧张时，系统会优先终止优先级较低的进程。
3. 还要设计进程重启和恢复：系统终止一个进程时，它可以选择重启进程或在需要时重新创建进程。这样可以确保重要的应用能够在内存紧张的情况下继续运行，并恢复到之前的状态。

从低优先级进程开始回收

1. Empty Process
2. Hidden Process
3. Perceptible Process
4. Visible Process
5. Foreground Process

备注：

每一个APP进程都有一个oom_adj值，该值是根据进程所运行的组件计算出来的，值越小，优先级就越级。

Init和System Server进程的oom_adj等于-16，是最高的，保证不会被杀死。

PhoneApp具有persist属性，它的oom_adj被设置为-12，也能保证不会被杀死。

可以通过/proc/<pid>oom_adj文件查看进程的oom_adj值。

在Linux内核中，子进程的oom_adj值等于父进程的oom_adj，也就是说，Android里面的Native进程的oom_adj值与fork它的进程的oom_adj值一样。




### 01.系统框架整体介绍
- Android系统 = Linux内核 + Android运行时
    - Android系统使用的Linux内核包含了一些专用驱动，例如Logger、Binder、Ashmem、Wakelock、Low-Memory Killer和Alarm等
    - Android运行时从下到上又包括了HAL层、应用程序框架层和应用程序层。
- HAL层
    - 将硬件驱动分成内核空间和用户空间两部分，其中用户空间两部分采用的是商业友好的Apache License。
- 应用程序框架层
    - 主要包括系统服务，例如组件管理服务、应用程序安装服务、窗口管理服务、多媒体服务和电信服务等。
- 应用程序层
    - 应用程序框架进一步又分为C/C++和Java两个层次，Java代码运行Dalvik虚拟机之上，并且通过JNI方法和C/C++交互。
    - 应用程序层主要就是由四大组件Activity、Service、Broadcast Receiver和Content Provider构成，它们是应用开发的基础。


### 02.Android专用驱动
- Logger
    - 完全内存操作，适合频繁读写
    - ![image](https://box.kancloud.cn/d1ad086e660cc704200cfa8966f6c4b0_573x507.jpg)
- Binder
    - Client/Server模型；进程间一次数据拷贝；数据安全的传输。
    - ![image](https://box.kancloud.cn/887eded306fad9269391aa8da0a43c95_784x465.jpg)



### 03.HAL硬件抽象层
- 设备驱动分为内核空间和用户空间两部分
    - 保护厂商利益（出发点）
    - 内核空间主要负责硬件访问逻辑（GPL）
    - 用户空间主要负责参数和访问流程控制（Apache License）
- 整体架构图
    - ![image](https://box.kancloud.cn/993b4084be40134e34456e2907347f30_722x454.jpg)



### 04.Android应用框架
- Android应用程序框架
    - 管理硬件
    - 提供服务
    - 组件管理
    - 进程管理



### 05.Android界面架构
- 窗口管理框架
    - Window
    - WindowManagerService
    - SurfaceFlinger
    - ![image](https://box.kancloud.cn/8bc177c30dbdbd85c96adf9cba796e90_698x608.png)
- 资源管理框架
    - AssetManager
    - Resources
    - ![image](https://box.kancloud.cn/52ade3f62b423568fa389cae5fdf64f5_580x559.jpg)














