# 11.距离传感器设计实践
#### 目录介绍
- 01.背景说明一下
  - 1.1 传感器业务场景
  - 1.2 门禁传感器介绍
  - 1.3 如何监听温度
- 02.传感器工作原理
  - 2.1 距离传感器工作原理
  - 2.2 温度传感器工作原理
- 03.距离传感器开发实践
  - 3.1 传感器开发思路
  - 3.2 距离监听回调
  - 3.3 注册和销毁时机
  - 3.4 功能消耗问题
  - 3.5 测试case说明
- 04.温度传感器开发实践
  - 4.1 温度传感器开发思路
  - 4.2 温度监听回调
- 05.Sensor源码流程
  - 5.1 Sensor整体架构
  - 5.2 SensorManager流程
  - 5.3 Android Sensor数据流

### 01.背景说明一下
#### 1.1 传感器业务场景
- 距离传感器的简单应用
    - 检测手机是否贴在耳朵上正在打电话，以便自动熄灭屏幕达到省电的目的。



#### 1.2 门禁传感器介绍
- 这次硬件做了比较大的升级，增加了距离传感器的功能。
    - 刷掌门禁需要适配距离传感器，通过距离判断相机是否休眠和启动，避免一直开启相机导致设备发热/采集质量变差问题



#### 1.3 如何监听温度
- 在Android系统中，获取CPU温度的方法并没有直接提供给我们开发者，可以通过两种方式来获取Cpu温度：
    - 1、通过读取手机传感器sensor的温度近似于手机CPU温度（当然这种方式只是一个近似的值，并不准确，同时还需要手机具备相应的传感器）
    - 2、通过读取CPU信息来获取（这种方式相较于前一种方式获取到的数据准确很多，但是还是有一定的局限性。）
- 注意点说明一下
    - 在实际的开发调试过程中，很多手机是没有温度传感器的。那此时，就只有通过直接读取Cpu信息来获取手机的CPU温度了。
- 读取CPU内核信息获取温度：
    - 具体看：https://www.jianshu.com/p/e946cf746dc0



### 02.传感器工作原理
#### 2.1 距离传感器工作原理
- 距离传感器通常基于红外线技术或超声波技术。
    - 红外线传感器使用红外线发射器和接收器来测量和计算物体与设备之间的距离。超声波传感器则通过发射和接收超声波信号来实现距离测量。
- 距离传感器工作原理如下：
    - 设备通过发射器发送红外线或超声波信号。
    - 当信号遇到物体时，一部分信号会被物体反射。
    - 传感器接收器接收到反射信号。
    - 通过计算发射和接收信号之间的时间差，并根据信号的传播速度，可以计算出物体与设备之间的距离。
- 智能手机上使用的距离传感器大多是红外距离传感器。
    - 当发射管发出的红外线被接收管接收到时，表明距离较近，而当接收管接收不到发射管发射的红外线时，表明距离较远。
    - Android中距离传感器会返回距离的数据，当传感器被遮挡距离较近时数值为0。



### 03.传感器开发实践
#### 3.1 传感器开发思路
- 开发传感器的思路步骤如下
    - 第一步： 获取传感器管理对象SensorManager 实例，SensorManager 是系统所有传感器的管理器。
    - 第二步： 从SensorManager中获取传感器目标传感器实例(本例中为 TYPE_PROXIMITY:距离传感器)。
    - 第三步: 为传感器注册监听器，监听传感器传回的数据。注意此处应该在onResume()函数中注册监听。
    - 第四步：重写监听器，自定义回调函数，当传感器读数发生变化时将变化后的读数显示出来。




#### 3.2 距离监听回调
- SensorEvent.values[0]:手机正面距离邻近物体的距离（CM）
    - 注意，该距离传感器，并不能感知物体距离的变化，只能感应到是否有物体靠近！


#### 3.3 注册和销毁时机


#### 3.4 功能消耗问题
- 距离传感器一些思考
    - 系统自带距离传感器，如果出现故障，该如何处理？距离传感器，频繁远近调用，处理频繁的回调注意内存的开销！


#### 3.5 测试case说明
- 距离传感器测试case说明
    - case1: 手掌靠近大概25cm，看看传感器距离的回调，是否达到有物体靠近
    - case2: 手掌靠近大概15cm，看看传感器距离的回调，是否达到有物体靠近 
    - case3: 使用其他物体/书本/水杯等靠近，看看距离传感器回调情况



### 04.温度传感器开发实践
#### 4.1 温度传感器开发思路
- 开发传感器的思路步骤如下
  - 第一步： 获取传感器管理对象SensorManager 实例，SensorManager 是系统所有传感器的管理器。
  - 第二步： 从SensorManager中获取传感器目标传感器实例(本例中为 TYPE_TEMPERATURE:温度传感器)。
  - 第三步: 为传感器注册监听器，监听传感器传回的数据。注意此处应该在onResume()函数中注册监听。
  - 第四步：重写监听器，自定义回调函数，当传感器读数发生变化时将变化后的读数显示出来。



#### 4.2 温度传感器


### 05.Sensor源码流程
#### 5.1 Sensor整体架构
- SensorManager 
    - 初始化并连接SensorService（SystemServer初始化时创建） 
    - 对应用层提供接口，获取sensor类型和sensor数据 
    - 处理sensor传感器数据，转化成android可以识别的数据格式
- SensorService
    - 根据平台动态加载hal层的库，初始化hal层 
    - 抓取底层数据根据需要向上转发sensor数据
- SensorHal 
    - 封装底层接口，对上提供统一接口 
    - 打开sensor设备，提供相关操作接口
- Sensor整体架构
    - ![image](https://img-blog.csdnimg.cn/direct/25938e6a5c5f497cb3daf0177fe9aa5d.png)




#### 5.2 SensorManager流程
- SensorManager流程如下：
    - App注册服务（SensorManager） 
    - 得到SensorManager，注册listener 
    - 创建消息队列queue，通过jni和sensorServer建立连接（socket方式） 
    - 接收数据，通过listener回调得到数据
- SensorService初始化流程
    - SystemServer初始化时，初始化SensorService 
    - SensorService创建SensorDevice对象，SensorDevice时hal层的操作函数集 
    - SensorDevice会得到系统支持sensor的个数及sensor操作接口 
    - SensorServer将系统支持的sensor添加到sensorList中 
    - 根据系统反馈创建虚拟sensor 
    - 等待连接，启动线程分发数据
- SensorService结构
    - ![image](https://img-blog.csdnimg.cn/direct/ea0b6674fdb94020a8ff7209f3fcf74f.png)



#### 5.3 Android Sensor数据流
- Android Sensor数据流
    - ![image](https://img-blog.csdnimg.cn/direct/4b6cf322b3e1432db9935601fc2c722d.png)









