# 06.韦根信号设计和原理
#### 目录介绍
- 01.Wiegand开发什么
  - 1.1 了解韦根协议
  - 1.2 硬件读卡器设计
  - 1.3 控制器设计
- 02.Wiegand开发事项
  - 2.1 韦根协议范围
  - 2.2 步骤和注意事项
  - 2.3 数据格式解析
  - 2.4 校验位验证
- 03.Wiegand原理技术
  - 3.1 物理层特性详解
  - 3.2 数据传输方式
  - 3.3 电平逻辑
  - 3.4 韦根协议数据格式
- 04.控制门禁开门技术
  - 4.1 传输过程
  - 4.2 刷卡动作
  - 4.3 门禁控制器工作逻辑
- 04.Wiegand数据格式
  - 4.1 26位输出格式
  - 4.2 34位输出格式
  - 4.3 32位输出格式



## 01.Wiegand开发是什么

### 1.1 了解韦根协议

Wiegand 是一种常用于门禁系统和访问控制系统的数据传输协议。

它使用两根线（通常是一根数据线和一根地线）来传输数据，其中一根线用于传输二进制数据的高电平信号，另一根线用于传输二进制数据的低电平信号。

Wiegand（韦根）协议是由摩托罗拉公司制定的一种通讯协议，门禁系统的读卡器、IC卡常用到这种协议。

### 1.2 硬件读卡器设计

读卡器设计：

1. 实现韦根协议的信号输出（DATA0 和 DATA1）。
2. 支持常见的卡片类型（如 EM4102、Mifare 等）。
3. 提供电源、信号指示灯等硬件接口。

### 1.3 控制器设计

控制器设计：

1. 接收并解析韦根协议的数据。
2. 实现门禁控制逻辑（如开门、报警等）。
3. 提供与其他设备（如服务器、摄像头）的通信接口。

## 02.Wiegand开发事项

### 2.1 韦根协议范围

韦根协议，一般是26位和34位。韦根号一般是十进制数字【有的是十六进制】

1. 26位韦根模式传输数值范围:0~16777215 
2. 32位韦根模式传输数值范围: 0~1073741823
3. 34位韦根模式传输数值范围: 0~4294967295
   
这里注意一个问题，也是前场用户经常遇到的一个问题。韦根号的取值范围不能超过所设置的韦根协议。比如1073741824，就不能用韦根26位和32位！

### 2.2 步骤和注意事项

进行 Wiegand 开发，以下是一些步骤和注意事项： 

1. 硬件设备：首先，您需要了解您所使用的硬件设备，例如读卡器和控制器。这些设备通常具有 Wiegand 接口，可以与其他设备进行数据交换。 
2. 数据格式：Wiegand 协议有不同的数据格式，如 26 位【最常见】、34 位、37 位等。您需要了解您所使用的具体数据格式，并根据需要解析和处理相应的数据。 
3. 数据传输：Wiegand 使用两根线来传输数据，一根线用于高电平信号，一根线用于低电平信号。您需要了解如何读取和解析这些信号，并将其转换为可用的数据。 
4. 数据处理：一旦您成功读取到 Wiegand 数据，您可以根据需要进行进一步的处理。这可能包括验证卡片信息、与数据库进行交互、控制门禁设备等。

标准26-bit 格式是一个开放式的格式：

这就意味着任何人都可以购买某一特定格式的HID卡，并且这些特定格式的种类是公开可选的。

26-Bit格式就是一个广泛使用的工业标准，并且对所有HID的用户开放。几乎所有的门禁控制系统都接受标准的26-Bit格式。

### 2.3 数据格式解析

解析韦根协议的数据位（如 26 位、34 位）。提取卡号或标识符。

### 2.4 校验位验证

校验位验证：计算并验证前校验位（Even Parity）和后校验位（Odd Parity）。主要是确保数据的正确性。

## 03.Wiegand原理技术

### 3.1 物理层特性详解

韦根协议通过两根信号线——DATA0和DATA1，以二进制方式传输信息。其工作原理简单而可靠，被广泛应用于26位、34位等格式的卡号传输中。

韦根协议的数据输出由两根信号线共同完成，这两根线分别代表二进制中的‘0’和‘1’输出。当输出为‘0’时，DATA0线上会产生一个负脉冲，其宽度TP固定为100微秒，周期TW则为1600微秒；而输出为‘1’时，则在DATA1线上产生相同宽度的负脉冲。

这种脉冲式的传输方式，确保了韦根协议在传输过程中的稳定性和准确性。

### 3.2 数据传输方式

韦根协议通过两根数据线——DATA0和DATA1来进行数据传输。在无数据传输状态下，这两根数据线均维持高电平，通常为+5V。

当需要传输数据时，会根据发送的数据位在相应线路上产生低电平脉冲。

具体来说，若发送的数据位为0，则DATA0线上会出现低电平脉冲，而DATA1线保持高电平；若发送的数据位为1，则相反，DATA1线上会出现低电平脉冲，而DATA0线保持高电平。

这种传输方式有助于确保韦根协议在数据传输过程中的稳定性和准确性。

### 3.3 电平逻辑

当D0线上的电平从高变为低时，这表示传输的二进制数据为0。这种电平变化在韦根协议的数据传输中具有重要意义，因为它直接关联着二进制数据的表示和解读。

当D1线上的电平从高降至低时，这同样具有重要意义，因为它标志着二进制数据的另一关键转变。这种下降沿的出现，在韦根协议的数据传输中，同样被紧密关联着二进制数据的解读与表示。

### 3.4 韦根协议数据格式

以一个26位韦根协议的数据格式示例：8位厂商码（Facility Code）紧接着16位用户码（Card ID），最后再加上2位校验位，共同构成了韦根协议的数据格式。

在解析这些数据时，我们采用特定的校验机制：前12位数据（即厂商码与用户码的前半部分）使用偶校验，而后12位数据（包括用户码的后半部分和校验位）则采用奇校验。

通过这种方式，我们可以确保在接收韦根信号并按照协议规则解码出完整的卡号时，数据的传输是准确无误的。

## 04.控制门禁开门技术

### 4.1 传输过程

当读卡器检测到卡片时，它会将卡号转换为韦根格式。这种格式通过D0和D1线逐位发送数据，而控制器则负责接收并验证这些数据的准确性。

韦根协议在门禁系统中主要扮演着传输刷卡信息的角色，如卡号或用户ID，从读卡器传递到控制器。

### 4.2 刷卡动作

当用户刷卡时，读卡器会感应并读取卡内芯片或磁条中存储的唯一卡号。这一动作是门禁系统中识别用户身份的关键步骤。

读卡器将感应到的卡号进行转换，形成特定格式的数据，例如韦根格式的26位或34位数据。这一转换过程是门禁系统进行后续处理的重要环节。

### 4.3 门禁控制器工作逻辑

门禁控制器在接收到读卡器传输的数据后，会首先解析出卡号，并将其与内部预先存储的授权列表进行比对。如果卡号是合法的，控制器会向电锁或磁力锁发送断电信号，从而解锁门禁；而如果卡号非法，控制器则会选择忽略该请求或触发警报系统。

在实际操作中，当有人刷卡时，门禁刷卡继电器的状态会发生改变，从常闭转为常开，导致整个线路断开。这时，电磁锁失去电源，门禁得以开启。

## 04.Wiegand数据格式

Wiegand 数据格式使用两个独立的线路（通常是一根称为D0的数据线和一根称为D1的数据线）来传输数据，二根线分别将0或1输出。

数据以二进制形式编码，通常由一串0和1的脉冲表示。每个脉冲的持续时间表示一个特定的位（0或1）。输出0时：DATA0线上出现负脉冲； 输出1时：DATA1线上出现负脉冲。

Wiegand 数据格式通常由三个主要部分组成：起始位（Start Bit）、数据位（Data Bits）和校验位（Parity Bit）。

起始位用于标识数据传输的开始，数据位包含实际的用户或卡片数据，而校验位用于验证数据的准确性。

### 4.1 Wiegand26位输出格式

Wiegand 26位各数据位的含义如下： 

- 第1 位:为输出数据2-13位的偶校验位 
- 第2-9位:ID卡的HID码的低8位 
- 第10-25位:1D卡的PID号码 
- 第 26 位:为输出数据14-25位的奇校验位

例如：一只HID：16385（0x4001），PID：00004的电子卡其26位韦根输出为：

- 第1位为2-13位的偶校验位 ---------------1
- 第2-9位对应与电子卡HID码的低8位 0 0 0 0 0 0 0 1
- 第10-25位对应电子卡的PID号码 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0
- 第26位为14-25位的奇校验位 0

读出的数据是：1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0

### 4.2 Wiegand34位输出格式

Wiegand 34位各数据位的含义如下： 

- 第 1 位： 为输出第2—17位的偶校验位 
- 第 2-17 位： ID卡的HID码 
- 第18-33位： ID卡的PID号码 
- 第 34 位： 为输出第18-33位的奇校验位 
- 数据输出顺序：HID码和PID码均为高位在前，低位在后。

例：一张ID卡内容为： 

- HID：32769   PID：34953  （假设卡面印字为：2147584137   001   34953 ） 
- 相应的二进制为： 
- HID：1000 0000 0000 0001 
- PID：1000 1000 1000 1001 

输出如下：

```text
12                     1718                     33  34

0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 10 0 0 1 0 0 0 1 0 0 1   0
```

### 4.3 32位输出格式






## 参考
- Android系统韦根调试从驱动到应用（一）
  - https://blog.csdn.net/blueheart05/article/details/106116954
- 韦根26和34格式怎么算数据，和开发相关知识。
  - https://blog.csdn.net/pawnxi/article/details/138218873
- 探索韦根协议在门禁系统中的应用与控制
  - https://baijiahao.baidu.com/s?id=1829284602356914438&wfr=spider&for=pc






