# 1.1请求网络的通用流程
#### 目录介绍
- 01.浏览器输入链接
  - 1.1 先思考几个问题
  - 1.2 网络访问的流程
  - 1.3 会发生哪些过程
- 02.网络分层设计
  - 2.1 分层的案例分析
  - 2.2 为何网络分层
  - 2.3 OSI真的很难学
  - 2.4 TCP/IP 4层模型
- 03.应用层设计流程
  - 3.1 搞懂约定协议
  - 3.2 HTTP传输协议
  - 3.3 域名解析IP
  - 3.4 DNS域名系统
  - 3.5 数据的处理转化
- 04.传输层设计流程
  - 4.1 传输协议设计
  - 4.2 TCP和UDP协议
  - 4.3 为何要端口号
- 05.网络层设计流程
  - 5.1 MAC层设计
  - 5.2 网关
  - 5.3 路由协议转发


## 01.浏览器输入链接
### 1.1 先思考几个问题

先思考几个问题

1. 在浏览器中输入了一个链接，为什么会打开网页，然后看到图片，文字，这些东西是哪里来的？
2. 在浏览器中输入非http类型链接，为何有的可以打开，有的打不开，对链接有何要求？
3. 为什么打开购物网站后，本来是打开我的收藏，但是去重定向到了首页登陆页面？

然后简述一下问题

1. 第一个问题：打开网页，会去请求服务器数据，然后返回response数据后，会渲染到网页上进行展示。
2. 第二个问题：浏览器输入链接，必须要求访问的链接scheme是受支持的，也就是支持的协议。否则未知的协议链接肯定打不开。
3. 第三个问题：针对购物网站，会有身份校验(token)的环节，如果过期了则会重定向到登陆页面进行登陆。

### 1.2 网络访问的流程

大概流程如下所示

- 域名解析
- TCP的三次握手
- 建立TCP连接后发起HTTP请求
- 服务器响应HTTP请求
- 浏览器解析html代码
- 同时请求html代码中的资源（如js、css、图片等）
- 最后浏览器对页面进行渲染并呈现给用户

重点说一下：三次握手

### 1.3 会发生哪些过程

主要会发生以下这些过程：域名解析、建立HTTP连接、发送HTTP请求、数据传输、渲染网页、断开HTTP连接。而这些离不开网络7层，下面打工充先来说一下网络分层的设计！

## 02.网络分层设计

### 2.1 分层的案例分析

说到分层，我们先从我们平时使用框架开发一个程序来说，我们往往会按照每一层做不同的事情的原则将系统分为 三层（复杂的系统分层可能会更多）:

1. Repository（数据库操作）
2. Service（业务操作）
3. Controller（前后端数据交互）

复杂的系统需要分层，因为每一层都需要专注于一类事情。我们的网络分层的原因也是一样，每一层只专注于做一类事情。

### 2.2 为何网络分层

为什么计算机网络要分层呢？我们再来较为系统的说一说：

1. 各层之间相互独立：各层之间相互独立，各层之间不需要关心其他层是如何实现的，只需要知道自己如何调用下层提供好的功能就可以了（可以简单理解为接口调用）。「这个和我们对开发时系统进行分层是一个道理。」 
2. 提高了整体灵活性：每一层都可以使用最适合的技术来实现，你只需要保证你提供的功能以及暴露的接口的规则没有改变就行了。「这个和我们平时开发系统的时候要求的高内聚、低耦合的原则也是可以对应上的。」
3. 大问题化小：分层可以将复杂的网络间题分解为许多比较小的、界线比较清晰简单的小问题来处理和解决。这样使得复杂的计算机网络系统变得易于设计，实现和标准化。 「这个和我们平时开发的时候，一般会将系统功能分解，然后将复杂的问题分解为容易理解的更小的问题是相对应的，这些较小的问题具有更好的边界（目标和接口）定义。」

说到计算机网络分层，我想到了计算机世界非常非常有名的一句话，这里分享一下：

**计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决，计算机整个体系从上到下都是按照严格的层次结构设计的**。

### 2.3 OSI真的很难学

网络模型一般是指OSI（Open System Interconnection开放系统互连）七层参考模型

| OSI中的层 | 功能  | TCP/IP协议族  |
| -------- | --------|  -------- |
| 7 应用层      	| 文件传输，电子邮件，文件服务，虚拟终端	| TFTP，HTTP，SNMP，FTP，SMTP，DNS，Telnet 等等	|
| 6 表示层      	| 数据格式化，代码转换，数据加密      	| 没有协议										|
| 5 会话层 		| 解除或建立与别的接点的联系      		| 没有协议										|
| 4 传输层 		| 提供端对端的接口      				| TCP，UDP										|
| 3 网络层 		| 为数据包选择路由      				| IP，ICMP，OSPF，EIGRP，IGMP					|
| 2 数据链路层 	| 传输有地址的帧以及错误检测功能      	| SLIP，CSLIP，PPP，MTU							|
| 1 物理层 		| 以二进制数据形式在物理媒体上传输数据	| ISO2110，IEEE802，IEEE802.2					|

### 2.4 TCP/IP 4层模型

这是目前被广泛采用的一种模型,我们可以将 TCP / IP 模型看作是 OSI 7层模型的精简版本，由以下4层组成：

1. 应用层
2. 传输层
3. 网络层
4. 网络接口层

**应用层协议**:

- HTTP 协议（超文本传输协议，网页浏览常用的协议）
- DHCP 协议（动态主机配置）
- DNS 系统原理（域名系统）
- FTP 协议（文件传输协议）
- Telnet协议（远程登陆协议）
- 电子邮件协议等（SMTP、POP3、IMAP）

**传输层协议**:

- TCP 协议
- 报文段结构
- 可靠数据传输
- 流量控制
- 拥塞控制
- UDP 协议
- 报文段结构
- RDT（可靠数据传输协议）

**网络层协议**:

- IP 协议（TCP/IP 协议的基础，分为 IPv4 和 IPv6）
- ARP 协议（地址解析协议，用于解析 IP 地址和 MAC 地址之间的映射）
- ICMP 协议（控制报文协议，用于发送控制消息）
- NAT 协议（网络地址转换协议）
- RIP 协议、OSPF 协议、BGP 协议（路由选择协议）

**网络接口层**:

- 差错检测技术
- 多路访问协议（信道复用技术）
- CSMA/CD 协议
- MAC 协议
- 以太网技术


## 03.应用层设计流程

### 3.1 搞懂约定协议

在计算机网络中，有许多约定的网络协议用于实现不同层级的通信和数据交换。

### 3.2 HTTP传输协议

知道了目标地址，浏览器就开始打包它的请求。

对于普通的浏览请求，往往会使用HTTP协议；但是对于购物的请求，往往需要进行加密传输，因而会使用HTTPS协议。无论是什么协议，里面都会写明“你要买什么和买多少”。

为何输入非http链接打不开？因为这是一种传输协议。


### 3.3 域名解析IP

浏览器只知道名字是“http://www.baidu.com”，但是不知道具体的地点，所以不知道应该如何访问。于是，它打开地址簿去查找。

可以使用一般的地址簿协议DNS去查找，还可以使用另一种更加精准的地址簿查找协议HTTPDNS。

无论用哪一种方法查找，最终都会得到这个地址：108.114.138.24，这也就是所说的域名解析。这个是IP地址，是互联网世界的“门牌号”。


### 3.4 DNS域名系统

域名系统（DNS，Domain Name System）将人类可读的域名 (例如，http://www.baidu.com) 转换为机器可读的 IP 地址 (例如，220.181.38.148)。」 我们可以将其理解为专为互联网设计的电话薄。

IP 地址是一个网卡再网络世界中的通讯地址，我们可以把它理解为我们现实世界中的家庭地址。

### 3.5 数据的处理转化

表示层负责处理数据的表示和转换，以确保不同系统之间的数据能够正确解释和交换。表示层的主要功能包括：

1. 数据格式化：表示层负责将应用层传递下来的数据进行格式化，以便在网络中传输。这包括数据的编码、压缩、加密等操作，以确保数据的可靠传输和安全性。
2. 数据加密与解密：表示层可以对数据进行加密，以保护数据的机密性。在接收端，表示层负责对加密的数据进行解密，以还原原始数据。
3. 数据压缩与解压缩：表示层可以对数据进行压缩，以减少数据在网络中的传输量，提高传输效率。在接收端，表示层负责对压缩的数据进行解压缩，以还原原始数据。
4. 数据格式转换：表示层可以将数据从一种格式转换为另一种格式，以便不同系统之间的数据交换。例如，将数据从一种编码方式转换为另一种编码方式，或将数据从一种数据结构转换为另一种数据结构。
5. 数据描述与标记：表示层可以为数据添加描述和标记，以便接收端能够正确解释和处理数据。这包括定义数据的结构、类型、顺序等信息，以确保数据的正确解析和使用。

表示层的主要目标是提供一种独立于具体应用的数据表示方式，使得不同系统之间能够进行可靠的数据交换和解释。它为上层的应用层提供了一个统一的接口，隐藏了底层网络的细节，使得应用程序能够以一种统一的方式处理数据。


## 04.传输层设计流程
### 4.1 传输协议设计

应用层到传输层，DNS、HTTP、HTTPS 所在的层我们称为应用层。经过应用层封装后，浏览器会将应用层的包交给下一层去完成，通过 socket 编程来实现。

### 4.2 TCP和UDP协议

传输层有两种协议，一种是无连接的协议UDP，一种是面向连接的协议TCP。

对于有支付来讲，往往使用 TCP 协议。所谓的面向连接就是，TCP 会保证这个包能够到达目的地。如果不能到达，就会重新发送，直至到达。

TCP 协议里面会有两个端口，一个是浏览器监听的端口，一个是电商的服务器监听的端口。操作系统往往通过端口来判断，它得到的包应该给哪个进程。

![image](https://upload-images.jianshu.io/upload_images/4432347-cb4fbeebae541701.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 4.3 为何要端口号

网络协议使用端口号来标识和区分不同的应用程序或服务。以下是一些原因：

1. 多应用程序通信：在计算机上同时运行多个应用程序时，每个应用程序都需要与网络进行通信。通过使用端口号，可以将传入的数据包路由到正确的应用程序，确保不同应用程序之间的通信不会混淆或冲突。 
2. 端到端通信：端口号使得网络通信成为端到端的，即从发送方的应用程序到接收方的应用程序。通过指定源端口和目标端口，数据包可以准确地传递到目标应用程序，而不会被其他应用程序接收。 
3. 标准化和互操作性：端口号的使用是为了标准化网络通信。通过约定一些常用的端口号，不同的应用程序和设备可以遵循相同的规则，实现互操作性。例如，HTTP使用端口号80，SMTP使用端口号25。 
4. 安全性和访问控制：端口号也用于实现安全性和访问控制。通过限制特定端口的访问权限，可以控制哪些应用程序可以接收传入的连接或数据包。这有助于防止未经授权的访问和网络攻击。 
5. 网络服务识别：通过查看目标端口号，可以识别正在运行的服务或应用程序。这对于网络管理、故障排除和监控非常有用，因为可以确定特定端口上的服务是否正常运行。


## 05.网络层设计流程
### 5.1 MAC层设计


### 5.2 网关


### 5.3 路由协议

----------------------------------------------------------------------------------------------------------------



### 05.网络层的流程分析过程
- 网络层处理逻辑
  - 传输层封装完毕后，浏览器会将包交给操作系统的网络层。网络层的协议是 IP 协议。在 IP 协议里面会有源 IP 地址，即浏览器所在机器的 IP 地址和目标地址，也即电商网站所在服务器的 IP 地址。
  - ![image](https://upload-images.jianshu.io/upload_images/4432347-a0fbc3afc74315db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
  - 操作系统知道了目标 IP 地址，就开始根据这个门牌号找到目标机器。操作系统往往会判断，这个目标 IP 地址是本地人，还是外地人。如果是本地人，从门牌号就能看出来，但是显然电商网站不在本地，而在遥远的地方。
  - 操作系统知道要离开本地去远方。虽然不知道远方在何处，但是可以这样类比一下：好比去国外要去海关，去外地就要去网关。而操作系统启动的时候，就会被 DHCP 协议配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1。
  - 操作系统将 IP 地址发给网关的时候，如果在本地通信基本靠吼，于是操作系统大吼一声，谁是 192.168.1.1 啊？网关会回答它，我就是，我的本地地址在那里。这个本地地址就是MAC地址，而大吼的那一声是ARP协议。
  - ![image](https://upload-images.jianshu.io/upload_images/4432347-beb1b425623d4173.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- MAC层处理逻辑
  - 于是操作系统将 IP 包交给了下一层，也就是MAC 层。网卡再将包发出去。由于这个包里面是有 MAC 地址的，因而它能够到达网关。
- 网关
  - 网关收到包之后，会根据自己的知识，判断下一步应该怎么走。网关往往是一个路由器，到某个 IP 地址应该怎么走，这个叫作路由表。路由器有点像玄奘西行路过的一个个国家的一个个城关。每个城关都连着两个国家，每个国家相当于一个局域网，在每个国家内部，都可以使用本地的地址 MAC 进行通信。一旦跨越城关，就需要拿出 IP 头来，里面写着贫僧来自东土大唐（就是源 IP 地址），欲往西天拜佛求经（指的是目标 IP 地址）。路过宝地，借宿一晚，明日启行，请问接下来该怎么走啊？
  - ![image](https://upload-images.jianshu.io/upload_images/4432347-28cb763f36f57e9a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- 路由协议
  - 城关往往是知道这些“知识”的，因为城关和临近的城关也会经常沟通。到哪里应该怎么走，这种沟通的协议称为路由协议，常用的有OSPF和BGP。
  - ![image](https://upload-images.jianshu.io/upload_images/4432347-a58ede9d63e80b3f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
  - 城关与城关之间是一个国家，当网络包知道了下一步去哪个城关，还是要使用国家内部的 MAC 地址，通过下一个城关的 MAC 地址，找到下一个城关，然后再问下一步的路怎么走，一直到走出最后一个城关。
  - 最后一个城关知道这个网络包要去的地方。于是，对着这个国家吼一声，谁是目标 IP 啊？目标服务器就会回复一个 MAC 地址。网络包过关后，通过这个 MAC 地址就能找到目标服务器。
  - 目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层。发现 IP 也对上了，就取下 IP 头。IP 头里会写上一层封装的是 TCP 协议，然后将其交给传输层，即TCP层。在这一层里，对于收到的每个包，都会有一个回复的包说明收到了。这个回复的包绝非这次下单请求的结果，例如购物是否成功，扣了多少钱等，而仅仅是 TCP 层的一个说明，即收到之后的回复。当然这个回复，会沿着刚才来的方向走回去，报个平安。因为一旦出了国门，西行路上千难万险，如果在这个过程中，网络包走丢了，例如进了大沙漠，或者被强盗抢劫杀害怎么办呢？因而到了要报个平安。
  - 如果过一段时间还是没到，发送端的 TCP 层会重新发送这个包，还是上面的过程，直到有一天收到平安到达的回复。这个重试绝非你的浏览器重新将下单这个动作重新请求一次。对于浏览器来讲，就只发送了一次下单请求，TCP 层不断自己闷头重试。除非 TCP 这一层出了问题，例如连接断了，才轮到浏览器的应用层重新发送下单请求。
  - 当网络包平安到达 TCP 层之后，TCP 头中有目标端口号，通过这个端口号，可以找到电商网站的进程正在监听这个端口号，假设一个 Tomcat，将这个包发给电商网站。[博客](https://github.com/yangchong211/YCBlogs)
- 电商网站处理逻辑
  - ![image](https://upload-images.jianshu.io/upload_images/4432347-b19c7b89debc6b3e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
  - 电商网站的进程得到 HTTP 请求的内容，知道了要买东西，买多少。往往一个电商网站最初接待请求的这个 Tomcat 只是个接待员，负责统筹处理这个请求，而不是所有的事情都自己做。例如，这个接待员要告诉专门管理订单的进程，登记要买某个商品，买多少，要告诉管理库存的进程，库存要减少多少，要告诉支付的进程，应该付多少钱，等等。
  - 那么，如何告诉相关的进程呢？往往通过 RPC 调用，即远程过程调用的方式来实现。远程过程调用就是当告诉管理订单进程的时候，接待员不用关心中间的网络互连问题，会由 RPC 框架统一处理。RPC 框架有很多种，有基于 HTTP 协议放在 HTTP 的报文里面的，有直接封装在 TCP 报文里面的。
  - 当接待员发现相应的部门都处理完毕，就回复一个 HTTPS 的包，告知下单成功。这个 HTTPS 的包，会像来的时候一样，经过千难万险到达你的个人电脑，最终进入浏览器，显示支付成功。


## 参考博客

字节一面：“为什么网络要分层？每一层的职责、包含哪些协议？”

https://zhuanlan.zhihu.com/p/598835439

掌握网络架构核心！了解为什么要分层

https://cloud.tencent.com/developer/article/2301115

