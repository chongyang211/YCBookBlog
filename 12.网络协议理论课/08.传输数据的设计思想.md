#### 目录介绍
- 01.数据传递的流程
  - 1.1 先看一个案例
  - 1.2 数据的发送处理
  - 1.3 数据接收处理
- 02.数据传输设计
  - 2.1 封装和解析报文
  - 2.2 什么是TCP流
  - 2.3 数据传输流程设计
  - 2.4 用例子理解流程
- 03.数据基础的设计
  - 3.1 报文设计思想
  - 3.2 数据报/报文段
  - 3.3 数据包的设计
  - 3.4 帧Frame的设计



## 01.数据传递的流程
### 1.1 先看一个案例

假设甲给乙发送邮件，内容为：“早上好”。而从 TCP/IP 通信上看，是从一台计算机 A 向另一台计算机 B 发送邮件。我们通过这个例子来讲解一下 TCP/IP 通信的过程。

![image](https://upload-images.jianshu.io/upload_images/4432347-74d36cc6089ddcc3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


### 1.2 数据的发送处理

1.应用程序处理

启动应用程序新建邮件，将收件人邮箱填好，再由键盘输入“早上好”，鼠标点击“发送”按钮就可以开始 TCP/IP 的通信了。

首先，应用程序会对邮件内容进行编码处理，例如：UTF-8，GB2312 等。这些编码相当于 OSI 的表示层功能。

应用在发送邮件的那一刻建立 TCP 连接，从而利用这个 TCP 连接发送数据。它的过程首先是将应用的数据发送给下一层的 TCP，在做实际的转发处理。

2.TCP 模块处理

TCP根据应用的提示，负责建立连接，发送数据以及断开连接。TCP 提供将应用层发来的数据顺利发送至对端的可靠传输。

为了实现 TCP 的这一功能，需要在应用层数据的前端附加一个 TCP 的首部。TCP 的首部中包括源端口号和目标端口号、序号。随后将附加了 TCP 首部的包再发送给 IP。

3.IP 模块处理

IP 将 TCP 传过来的 TCP 首部和 TCP 数据合起来当做自己的数据，并在 TCP 首部的前端加上自己的 IP 首部。IP 首部中包含接收端 IP 地址，发送端 IP 地址。随后 IP 包将被发送给连接这些路由器或主机网络接口的驱动程序，以实现真正的发送数据。

4.网络接口（以太网驱动）的处理

从 IP 传过来的 IP 包，对于以太网卡来说就是数据。给这些数据附加上以太网首部并进行发送处理。以太网首部中包含接收端 MAC 地址，发送端 MAC 地址，以太网类型，以太网数据协议。根据上述信息产生的以太网数据将被通过物理层传输给接收端。

### 1.3 数据接收处理

1.网络接口（以太网驱动）的处理

主机收到以太网包以后，首先从以太网的包首部找到 MAC 地址判断是否为发给自己的包。如果不是发给自己的则丢弃数据，如果是发给自己的则将数据传给处理 IP 的子程序。

2.IP 模块处理

IP 模块收到 IP 包首部以及后面的数据部分以后，也做类似的处理。如果判断得出包首部的 IP 地址与自己的 IP 地址匹配，则可接受数据并从中查找上一层的协议。并将后面的数据传给 TCP 或者 UDP 处理。对于有路由的情况下，接收端的地址往往不是自己的地址，此时需要借助路由控制表，从中找出应该送到的主机或者路由器以后再进行转发数据。

3.TCP 模块处理

在 TCP 模块中，首先会校验数据是否被破坏，然后检查是否在按照序号接收数据。最后检查端口号，确定具体的应用程序。数据接收完毕后，接收端则发送一个“确认绘制”给发送端。数据被完整地接收以后，会传给由端口号识别的应用程序。

4.应用程序处理

接收端应用程序会直接接收发送端发送的数据。通过解析数据可以获知邮件的内容信息。

## 02.数据传输设计
### 2.1 封装和解析报文

封装报文是从上层到下层：应用层-->传输层-->网络层-->数据链路层-->物理层 ，解封装报文是从下层到上层。

### 2.2 什么是TCP流

这里的 TCP 流，就是英文的 TCP Stream。Stream 这个词有“流”的意思，也有“连续的事件”这样一个含义，所以它是有前后、有顺序的，这也正对应了 TCP 的特性。

跟 Stream 相对的一个词是 Datagram，它是指没有前后关系的数据单元，比如 UDP 和 IP 都属于 Datagram。

在 Linux 网络编程里面，TCP 对应的 socket 类型是 SOCK_STREAM，而 UDP 对应的，就是 SOCK_DGRAM 了。显然，DGRAM 就是 Datagram 的简写。

在具体的网络报文层面，一个 TCP 流，对应的就是一个五元组：传输协议类型、源 IP、源端口、目的 IP、目的端口。

```text
(TCP,  your_ip,  your_port,  geekbang_ip,  443)
```

一个 IP 报文，包含了所有这五个元素，所以 Wireshark 在解析抓包文件时，自然就能通过五元组知道每个报文所属的 TCP 流了。

### 2.3 数据传输流程设计

报文由应用层产生，被称作报文（Message）/数据（Data），经过传输层的封装形成报文段（Segment）/数据报（Datagram），再经过网络层的封装形成分组/数据包（Packet），然后经过数据链路层的封装形成帧（Frame），最后在物理层以二进制比特流的方式完成数据传输。

在传输过程中，每层都会添加一些控制信息组成的首部，那些就是报文头。在接收端，每层都会把自己添加的首部去掉，再还原出原始的数据。

### 2.4 用例子理解流程

发快递——>可以理解为发送数据

1. 应用层：用户寄快递时，相当于处在应用层，货物就是报文。
2. 运输层：在寄件点填写好目的地信息后形成数据报，处在运输层。
3. 网络层：物流中心以自己的方式标记目的地信息形成数据包，处在网络层。
4. 数据链路层：物流中心选择运输工具，比如飞机，货车等，数据链路层负责选择运输工具添加帧头帧尾，形成数据帧。
5. 物理层：快递需要完成派送，即数据以比特流的形式完成传输。

收快递——>可以理解为接收数据

1. 到达目的地后，再逐层去掉自己所在层级添加的首部，也可理解为根据快递地址信息逐层分派，最后送达我们的收件人手上，我们的货物是不变的。

## 03.数据基础的设计

### 3.1 报文设计思想

我们将位于应用层的信息分组称为报文。报文是网络中交换与传输的数据单元，即站点一次性要发送的数据块。报文包含了将要发送的完整的数据信息，其长短很不一致，长度不限且可变。



### 3.2 数据报/报文段

现在来到传输层了，传输层要结合以下两种协议来讲：

1. 一是我们经常听到的TCP（Transmission Control Protocol）协议，即传输控制协议，它是面向连接的，数据传输的单位是报文段，能够提供可靠的交付。 
2. 二是UDP（User Datagram Protocol）协议，即用户数据包协议，它是无连接的，数据传输的单位是用户数据报，不保证提供可靠的交付，只能提供“尽最大努力交付”。

### 3.3 数据包的设计

数据包（Packet）是TCP/IP协议通信传输中的数据单位，处于网络层，在局域网中，“包”是包含在“帧”里的。有些资料里会将其称为IP数据报，但只是叫法不同罢了。

### 3.4 帧Frame的设计

帧是数据链路层的传输单元。将上层传输的数据添加一个头部和尾部，组成了帧。



### 参考

https://cloud.tencent.com/developer/article/2301115

https://zhuanlan.zhihu.com/p/705751265


